name: CI — Scan & Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Daily at 7am UTC (midnight PT)
    - cron: '0 7 * * *'
  workflow_dispatch: {}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx tsc --noEmit --pretty
        id: typecheck
      - name: Annotate TypeScript errors
        if: failure()
        run: echo "::error::TypeScript compilation failed. Run 'npx tsc --noEmit' locally to see details."

  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run ESLint
        id: lint
        run: |
          set +e
          OUTPUT=$(npx eslint . --ext .ts,.tsx 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -qE '[0-9]+ errors?'; then
            ERROR_COUNT=$(echo "$OUTPUT" | grep -oE '([0-9]+) errors?' | grep -oE '[0-9]+' | tail -1)
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "::error::ESLint found $ERROR_COUNT error(s). Run 'npx eslint . --ext .ts,.tsx --fix' locally."
              exit 1
            fi
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::ESLint found warnings. Run 'npx eslint . --ext .ts,.tsx' locally to review."
          fi

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx vitest run --reporter=verbose 2>&1 | tee test-output.txt
        id: test
      - name: Upload test output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-output.txt
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [typecheck, lint, test]
    env:
      NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder
      NEXT_PUBLIC_BASE_URL: https://app.wunderbrand.ai
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: placeholder
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
        id: build
        env:
          NEXT_TELEMETRY_DISABLED: 1
      - name: Report build status
        if: failure()
        run: echo "::error::Next.js build failed. Run 'npm run build' locally to debug."

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run npm audit
        run: |
          set +e
          OUTPUT=$(npm audit --production --audit-level=high 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::npm audit found vulnerabilities. Run 'npm audit' locally."
          fi

  prompt-integrity:
    name: Prompt Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx vitest run tests/promptStructure.test.ts --reporter=verbose
        id: prompts

  summary:
    name: Health Summary
    runs-on: ubuntu-latest
    needs: [typecheck, lint, test, build, prompt-integrity, audit]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Health Check Summary"
          echo ""
          echo "| Check | Status |"
          echo "|-------|--------|"
          echo "| TypeScript | ${{ needs.typecheck.result == 'success' && '✅ Pass' || '❌ Fail' }} |"
          echo "| ESLint | ${{ needs.lint.result == 'success' && '✅ Pass' || '❌ Fail' }} |"
          echo "| Tests | ${{ needs.test.result == 'success' && '✅ Pass' || '❌ Fail' }} |"
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Pass' || '❌ Fail' }} |"
          echo "| Prompts | ${{ needs.prompt-integrity.result == 'success' && '✅ Pass' || '❌ Fail' }} |"
          echo "| Security | ${{ needs.audit.result == 'success' && '✅ Pass' || '⚠️ Review' }} |"

          if [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.prompt-integrity.result }}" != "success" ]]; then
            echo ""
            echo "❌ One or more checks failed."
            exit 1
          fi

          echo ""
          echo "✅ All checks passed."
